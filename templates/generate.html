{% extends "base.html" %}
{% block title %}MusicGen Studio · Generate{% endblock %}
{% block body_attrs %}data-route="generate"{% endblock %}
{% block content %}
<h2 style="margin-top:0;">Generate Music</h2>
<p style="color:#9ca3af;">Enter a descriptive prompt to create a custom clip. Mood and sentiment predictions will appear with each result.</p>

<form id="generate-form" style="display:grid;gap:1rem;margin-top:1.5rem;">
	<label>
		Prompt
		<textarea id="prompt" rows="4" required placeholder="e.g. upbeat synthwave track with retro drums"></textarea>
	</label>
	<label>
		Duration (seconds)
		<input id="duration" type="number" min="1" max="30" value="10" />
	</label>
	<button type="submit">Generate</button>
</form>

<section id="result" style="display:none;margin-top:2rem;border-radius:14px;padding:1.25rem;background:rgba(15,23,42,0.65);border:1px solid rgba(148,163,184,0.25);">
	<h3 style="margin-top:0;">Latest Result</h3>
	<p><strong>Mood:</strong> <span id="result-mood"></span></p>
	<p><strong>Sentiment:</strong> <span id="result-sentiment"></span></p>
	<p><strong>Prompt:</strong> <span id="result-prompt"></span></p>
	<audio id="result-audio" controls style="width:100%;margin-top:0.75rem;"></audio>
	<p style="margin-top:0.75rem;"><a id="download-link" href="#" download style="color:#38bdf8;">Download WAV</a></p>
</section>

<div class="status" id="status">Waiting for prompt...</div>

<p style="margin-top:1.5rem;color:#9ca3af;font-size:0.9rem;">
	<strong>Note:</strong> The first generation may take several minutes while models load (≈2.5GB). Subsequent requests are much faster.
</p>
{% endblock %}

{% block extra_scripts %}
<script>
	const statusBox = document.getElementById('status');
	const resultBox = document.getElementById('result');
	const moodSpan = document.getElementById('result-mood');
	const sentimentSpan = document.getElementById('result-sentiment');
	const promptSpan = document.getElementById('result-prompt');
	const audioEl = document.getElementById('result-audio');
	const downloadLink = document.getElementById('download-link');

	function getToken() {
		return localStorage.getItem('musicgen_access_token');
	}

	function ensureAuth() {
		const token = getToken();
		if (!token) {
			statusBox.textContent = 'Please log in first. Redirecting to login...';
			statusBox.style.color = '#f87171';
			setTimeout(() => {
				window.location.href = '/login/';
			}, 800);
			return false;
		}
		return true;
	}

	function setStatus(message, isError = false) {
		statusBox.textContent = message;
		statusBox.style.color = isError ? '#f87171' : 'inherit';
	}

	document.getElementById('generate-form').addEventListener('submit', async (event) => {
		event.preventDefault();
		if (!ensureAuth()) {
			return;
		}
		const payload = {
			prompt: document.getElementById('prompt').value.trim(),
			duration: parseInt(document.getElementById('duration').value, 10) || 10,
		};
		if (!payload.prompt) {
			setStatus('Prompt cannot be empty.', true);
			return;
		}
		setStatus('Generating music... this may take a while.');
		try {
			const response = await fetch('/api/generate/', {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json',
					'Authorization': `Bearer ${getToken()}`,
				},
				body: JSON.stringify(payload),
			});
			if (!response.ok) {
				const text = await response.text();
				throw new Error(text || response.statusText);
			}
			const data = await response.json();
			const audioUrl = data.audio_file.startsWith('http') ? data.audio_file : `${window.location.origin}${data.audio_file}`;
			moodSpan.textContent = data.mood;
			sentimentSpan.textContent = data.sentiment;
			promptSpan.textContent = data.prompt;
			audioEl.src = audioUrl;
			audioEl.load();
			downloadLink.href = audioUrl;
			resultBox.style.display = 'block';
			setStatus('Generation complete. Listen to your clip below.');
		} catch (error) {
			setStatus(`Generation failed: ${error.message}`, true);
		}
	});

	window.addEventListener('DOMContentLoaded', () => {
		ensureAuth();
	});
</script>
{% endblock %}

