{% extends "base.html" %}
{% block title %}MusicGen Studio Â· Login{% endblock %}
{% block body_attrs %}data-route="login"{% endblock %}
{% block content %}
<h2 style="margin-top:0;">Log In</h2>
<p style="color:#9ca3af;">Enter your credentials to access music generation and history.</p>

<form id="login-form" style="display:grid;gap:1rem;margin-top:1.5rem;">
	<label>
		Username
		<input id="username" required />
	</label>
	<label>
		Password
		<input id="password" type="password" required />
	</label>
	<button type="submit">Log In</button>
</form>

<div class="status" id="status">Awaiting credentials...</div>

<p style="margin-top:1.5rem;">Need an account? <a href="/register/" style="color:#38bdf8;">Register here</a>.</p>
{% endblock %}

{% block extra_scripts %}
<script>
	const statusBox = document.getElementById('status');
	function setStatus(message, isError = false) {
		statusBox.textContent = message;
		statusBox.style.color = isError ? '#f87171' : 'inherit';
	}

	document.getElementById('login-form').addEventListener('submit', async (event) => {
		event.preventDefault();
		setStatus('Authenticating...');
		const payload = {
			username: document.getElementById('username').value.trim(),
			password: document.getElementById('password').value,
		};
		try {
			const response = await fetch('/api/login/', {
				method: 'POST',
				headers: { 'Content-Type': 'application/json' },
				body: JSON.stringify(payload),
			});
			if (!response.ok) {
				const text = await response.text();
				throw new Error(text || response.statusText);
			}
			const data = await response.json();
			localStorage.setItem('musicgen_access_token', data.access);
			localStorage.setItem('musicgen_refresh_token', data.refresh);
			setStatus('Login successful. Redirecting to generate page...');
			setTimeout(() => {
				window.location.href = '/generate/';
			}, 800);
		} catch (error) {
			setStatus(`Login failed: ${error.message}`, true);
		}
	});

	window.addEventListener('DOMContentLoaded', () => {
		if (localStorage.getItem('musicgen_access_token')) {
			setStatus('Already logged in. Redirecting...');
			setTimeout(() => {
				window.location.href = '/generate/';
			}, 600);
		}
	});
</script>
{% endblock %}

