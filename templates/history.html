{% extends "base.html" %}
{% block title %}MusicGen Studio Â· History{% endblock %}
{% block body_attrs %}data-route="history"{% endblock %}
{% block content %}
<h2 style="margin-top:0;">Generation History</h2>
<p style="color:#9ca3af;">Review and replay previously generated clips. Use the Refresh button if you generate new music in another tab.</p>

<div style="display:flex;align-items:center;gap:1rem;margin-top:1rem;">
	<button id="refresh">Refresh</button>
	<button id="logout" style="background:linear-gradient(135deg,#ef4444,#f97316);">Logout</button>
</div>

<div class="status" id="status" style="margin-top:1.5rem;">Loading history...</div>

<section id="empty" style="display:none;margin-top:1.5rem;color:#94a3b8;">
	No generations yet. Head over to <a href="/generate/" style="color:#38bdf8;">Generate</a> to create your first track.
</section>

<div id="history-list" style="margin-top:1.5rem;display:grid;gap:1rem;"></div>
{% endblock %}

{% block extra_scripts %}
<script>
	const statusBox = document.getElementById('status');
	const historyList = document.getElementById('history-list');
	const emptyState = document.getElementById('empty');

	function getToken() {
		return localStorage.getItem('musicgen_access_token');
	}

	function ensureAuth() {
		const token = getToken();
		if (!token) {
			statusBox.textContent = 'Please log in first. Redirecting...';
			statusBox.style.color = '#f87171';
			setTimeout(() => {
				window.location.href = '/login/';
			}, 800);
			return false;
		}
		return true;
	}

	function setStatus(message, isError = false) {
		statusBox.textContent = message;
		statusBox.style.color = isError ? '#f87171' : 'inherit';
	}

	async function loadHistory() {
		if (!ensureAuth()) return;
		setStatus('Fetching history...');
		try {
			const response = await fetch('/api/history/', {
				headers: {
					'Authorization': `Bearer ${getToken()}`,
				},
			});
			if (!response.ok) {
				const text = await response.text();
				throw new Error(text || response.statusText);
			}
			const data = await response.json();
			historyList.innerHTML = '';
			if (!Array.isArray(data) || data.length === 0) {
				emptyState.style.display = 'block';
				setStatus('No history yet.');
				return;
			}
			emptyState.style.display = 'none';
			for (const item of data) {
				const card = document.createElement('div');
				card.style.background = 'rgba(15,23,42,0.65)';
				card.style.border = '1px solid rgba(148,163,184,0.25)';
				card.style.borderRadius = '14px';
				card.style.padding = '1.25rem';
				card.style.display = 'grid';
				card.style.gap = '0.5rem';
				const audioUrl = item.audio_file.startsWith('http') ? item.audio_file : `${window.location.origin}${item.audio_file}`;
				card.innerHTML = `
					<div><strong>Prompt:</strong> ${item.prompt}</div>
					<div><strong>Mood:</strong> ${item.mood}&nbsp; | &nbsp;<strong>Sentiment:</strong> ${item.sentiment}</div>
					<div><strong>Created:</strong> ${new Date(item.created_at).toLocaleString()}</div>
				`;
				const audio = document.createElement('audio');
				audio.controls = true;
				audio.src = audioUrl;
				audio.style.width = '100%';
				card.appendChild(audio);
				const link = document.createElement('a');
				link.href = audioUrl;
				link.target = '_blank';
				link.textContent = 'Open file';
				link.style.color = '#38bdf8';
				card.appendChild(link);
				historyList.appendChild(card);
			}
			setStatus('History loaded.');
		} catch (error) {
			setStatus(`Failed to load history: ${error.message}`, true);
		}
	}

	document.getElementById('refresh').addEventListener('click', loadHistory);

	document.getElementById('logout').addEventListener('click', () => {
		localStorage.removeItem('musicgen_access_token');
		localStorage.removeItem('musicgen_refresh_token');
		setStatus('Logged out. Redirecting to login...');
		setTimeout(() => {
			window.location.href = '/login/';
		}, 600);
	});

	window.addEventListener('DOMContentLoaded', () => {
		if (ensureAuth()) {
			loadHistory();
		}
	});
</script>
{% endblock %}

