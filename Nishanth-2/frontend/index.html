<!DOCTYPE html>
<html>
<head>
    <title>NexGenMusic</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins&display=swap">
    
    <style>
        body {
            background-color: #121212;
            color: #fff;
            font-family: 'Poppins', sans-serif;
            text-align: center;
            margin: 0;
            padding: 0;
        }

        /* NAVBAR */
        .navbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #181818;
            padding: 10px 30px;
            box-shadow: 0 0 10px rgba(30, 215, 96, 0.3);
        }
        .navbar h2 {
            color: #1DB954;
            margin: 0;
            font-size: 22px;
        }
        .navbar ul {
            list-style: none;
            display: flex;
            gap: 20px;
            margin: 0;
            padding: 0;
        }
        .navbar ul li a {
            color: #fff;
            text-decoration: none;
            font-weight: bold;
            transition: color 0.3s;
        }
        .navbar ul li a:hover {
            color: #1DB954;
        }
        .logout-btn {
            background-color: transparent;
            color: #1DB954;
            border: 1px solid #1DB954;
            padding: 6px 12px;
            border-radius: 5px;
            cursor: pointer;
            transition: 0.3s;
        }
        .logout-btn:hover {
            background-color: #1DB954;
            color: #121212;
        }

        /* MAIN */
        form, #authSection, #musicSection {
            background: #181818;
            padding: 25px;
            border-radius: 12px;
            width: 350px;
            margin: 30px auto;
            box-shadow: 0 0 10px rgba(0, 255, 100, 0.3);
        }

        input {
            width: 90%;
            padding: 10px;
            margin: 8px 0;
            border: none;
            border-radius: 6px;
        }

        button {
            background-color: #1DB954;
            border: none;
            padding: 10px 20px;
            color: white;
            border-radius: 6px;
            cursor: pointer;
            transition: 0.3s;
        }
        button:hover {
            background-color: #1ed760;
        }

        #result, #history {
            background: #181818;
            padding: 15px;
            border-radius: 10px;
            width: 60%;
            margin: 20px auto;
            text-align: left;
            font-size: 14px;
            box-shadow: 0 0 10px rgba(30, 215, 96, 0.2);
        }

        a { color: #1DB954; text-decoration: none; }
        a:hover { text-decoration: underline; }
    </style>
</head>

<body>

    <!-- NAVBAR -->
    <div class="navbar">
        <h2>ðŸŽµ NexGenMusic</h2>
        <ul>
            <li><a href="#" onclick="showMusicSection()">Home</a></li>
            <li><a href="#" onclick="loadHistory()">History</a></li>
            <li><button class="logout-btn" onclick="logoutUser()">Logout</button></li>
        </ul>
    </div>

    <!-- LOGIN / REGISTER SECTION -->
    <div id="authSection">
        <h3>Login / Register</h3>
        <input type="text" id="username" placeholder="Username"><br>
        <input type="password" id="password" placeholder="Password"><br>
        <button onclick="registerUser()">Register</button>
        <button onclick="loginUser()">Login</button>
        <p id="authMsg"></p>
    </div>

    <!-- MUSIC GENERATOR SECTION -->
    <div id="musicSection" style="display:none;">
        <h3>Generate AI Music</h3>
        <input type="text" id="textInput" placeholder="Describe your mood (optional)"><br>
        <input type="text" id="mood" placeholder="Mood (happy, sad, calm)"><br>
        <input type="text" id="genre" placeholder="Genre (pop, rock, jazz)"><br>
        <button onclick="generateMusic()">ðŸŽ¶ Generate Music</button>
        <p id="musicMsg"></p>
        <div id="song"></div>

        <div id="historySection">
            <h3>Your Music History</h3>
            <ul id="historyList"></ul>
        </div>
    </div>

    <script>
    const apiBase = 'http://127.0.0.1:8000/api/';

    // Show/Hide Sections
    function showMusicSection() {
        document.getElementById('authSection').style.display = 'none';
        document.getElementById('musicSection').style.display = 'block';
        loadHistory();
    }
    function showAuthSection() {
        document.getElementById('authSection').style.display = 'block';
        document.getElementById('musicSection').style.display = 'none';
    }

    // Check login status on page load
    window.onload = () => {
        const token = localStorage.getItem('token');
        if (token) showMusicSection();
        else showAuthSection();
    };

    // Register User
    async function registerUser() {
        const username = document.getElementById('username').value.trim();
        const password = document.getElementById('password').value.trim();
        if (!username || !password) return alert('Enter username & password');
        const res = await fetch(apiBase + 'register/', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username, password })
        });
        const data = await res.json();
        if (data.access) {
            localStorage.setItem('token', data.access);
            showMusicSection();
        } else alert('Registration failed');
    }

    // Login User
    async function loginUser() {
        const username = document.getElementById('username').value.trim();
        const password = document.getElementById('password').value.trim();
        if (!username || !password) return alert('Enter username & password');
        const res = await fetch(apiBase + 'login/', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username, password })
        });
        const data = await res.json();
        if (data.access) {
            localStorage.setItem('token', data.access);
            showMusicSection();
        } else alert('Login failed');
    }

    // Generate Music
    async function generateMusic() {
        const mood = document.getElementById('mood').value.trim();
        const genre = document.getElementById('genre').value.trim();
        const text = document.getElementById('textInput').value.trim();
        const token = localStorage.getItem('token');
        if (!token) return alert('Login first!');
        const res = await fetch(apiBase + 'generate/', {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + token
            },
            body: JSON.stringify({ mood, genre, text })
        });
        const data = await res.json();
        if (data.spotify_url) {
            document.getElementById('song').innerHTML = `
                <p>Predicted Mood: ${data.mood}</p>
                <p><strong>${data.song_name}</strong> - ${data.artist_name}</p>
                <a href="${data.spotify_url}" target="_blank">ðŸŽ§ Play on Spotify</a>
            `;
            loadHistory();
        } else {
            document.getElementById('musicMsg').innerText = data.error || 'No song found';
        }
    }

    // Load History
    async function loadHistory() {
        const token = localStorage.getItem('token');
        if (!token) return;
        const res = await fetch(apiBase + 'history/', {
            method: 'GET',
            headers: { 'Authorization': 'Bearer ' + token }
        });
        const data = await res.json();
        const list = document.getElementById('historyList');
        list.innerHTML = '';
        if (!data || data.length === 0) {
            list.innerHTML = '<li>No songs generated yet.</li>';
        } else {
            data.forEach(item => {
                list.innerHTML += `
                    <li>${item.mood} / ${item.genre} â†’ 
                    <a href="${item.spotify_song_url}" target="_blank">Play</a></li>`;
            });
        }
    }

    // Logout
    function logoutUser() {
        localStorage.removeItem('token');
        alert('Logged out successfully!');
        showAuthSection();
    }
    </script>

</body>
</html>