<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>AI Music Dashboard</title>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-900 text-white">

  <div class="max-w-3xl mx-auto mt-10 p-6 bg-gray-800 rounded-2xl shadow-xl">

    <h1 class="text-3xl font-bold text-teal-400 mb-6 text-center">
      ðŸŽµ AI Music Generator Dashboard
    </h1>

    <!-- Prompt Input -->
    <textarea id="promptInput" class="w-full p-4 rounded-lg bg-gray-700 border border-gray-600"
      placeholder="Enter your mood / message"></textarea>

    <button onclick="generateMusic()"
      class="mt-4 w-full bg-teal-500 hover:bg-teal-600 text-white font-bold py-3 rounded-lg">
      ðŸŽ¶ Generate Music
    </button>

    <!-- Result Box -->
    <div id="resultBox" class="mt-6 p-5 bg-gray-700 rounded-xl hidden">
      <h2 class="text-xl font-bold mb-3 text-teal-300">Detected Results</h2>

      <p><strong>Mood:</strong> <span id="moodText" class="text-yellow-300"></span></p>
      <p><strong>Sentiment:</strong> <span id="sentimentText" class="text-pink-300"></span></p>
      <p><strong>Sentiment Score:</strong> <span id="sentimentScore" class="text-blue-300"></span></p>

      <audio id="audioPlayer" class="mt-4 w-full" controls></audio>
    </div>

    <!-- History Box -->
    <div id="historyBox" class="mt-10 p-5 bg-gray-700 rounded-xl">
      <h2 class="text-xl font-bold mb-3 text-teal-300">ðŸŽµ Your Music History</h2>
      <p id="historyEmpty" class="text-gray-400">No history yet. Generate some music!</p>
    </div>
  </div>

  <script>
    const csrftoken = "{{ csrf_token }}"; // Ensure CSRF token is available in template

    // ---------------- Generate Music ----------------
    function generateMusic() {
      let prompt = document.getElementById("promptInput").value;

      if (!prompt) return alert("Please enter a prompt!");

      fetch("/api/genmusic/", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": csrftoken
        },
        credentials: "same-origin",
        body: JSON.stringify({ prompt: prompt })
      })
        .then(res => res.json())
        .then(data => {
          document.getElementById("resultBox").classList.remove("hidden");

          document.getElementById("moodText").innerText = data.mood.toUpperCase();
          document.getElementById("sentimentText").innerText = data.sentiment.toUpperCase();
          document.getElementById("sentimentScore").innerText = data.sentiment_score.toFixed(3);

          document.getElementById("audioPlayer").src = data.file_url;

          // Refresh history
          fetchHistory();
        });
    }

    // ---------------- Fetch History ----------------
    function fetchHistory() {
      fetch("/api/history/", {
        method: "GET",
        credentials: "same-origin"
      })
        .then(res => res.json())
        .then(data => {
          const historyBox = document.getElementById("historyBox");
          historyBox.innerHTML = `
            <h2 class="text-xl font-bold mb-3 text-teal-300">ðŸŽµ Your Music History</h2>
          `;

          if (!data.history || data.history.length === 0) {
            historyBox.innerHTML += `<p id="historyEmpty" class="text-gray-400">No history yet. Generate some music!</p>`;
            return;
          }

          data.history.forEach(item => {
            historyBox.innerHTML += `
              <div class="mb-3 p-2 bg-gray-600 rounded">
                <p><strong>Prompt:</strong> ${item.prompt}</p>
                <p><strong>Mood:</strong> ${item.mood}</p>
                <p><strong>Created At:</strong> ${item.created_at}</p>
                <audio class="mt-2 w-full" controls src="${item.file_url}"></audio>
              </div>
            `;
          });
        });
    }

    // ---------------- Initialize ----------------
    window.onload = () => {
      fetchHistory();  // Load history when dashboard loads
    }
  </script>

</body>

</html>
